<!DOCTYPE html>
<html>

<head>
   <title>Profile Generator</title>
   <style>
      .card {
         max-width: 400px;
         min-height: 250px;
         background: #02b875;
         padding: 30px;
         box-sizing: border-box;
         color: #FFF;
         margin: 20px;
         box-shadow: 0px 2px 18px -4px rgba(0, 0, 0, 0.75);
      }

      .button {
         background-color: #1c87c9;
         border: none;
         color: white;
         padding: 20px 20px;
         width: 150px;
         text-align: center;
         text-decoration: none;
         display: inline-block;
         font-size: 10px;
         margin: 4px 2px;
         cursor: pointer;
      }
   </style>
</head>

<body>
   <center>
      <div class="card">
         <h1>Profile Generator</h1>
         <table>
            <tr>
               <td><label for="weightInput">Weight for 3600 steps:</label></td>
               <td><input type="number" id="weightInput" step="0.0001" min="0" value="0.1"></td>
            </tr>
            <tr>
               <td><label for="speedInput">Stepper Speed:</label></td>
               <td><input type="number" id="speedInput" step="1" min="5" value="200"></td>
            </tr>
            <tr>
               <td><label for="oscillateCheckbox">Oscillate:</label></td>
               <td><input type="checkbox" id="oscillateCheckbox"></td>
            </tr>
            <tr>
               <td><label for="gramRadio">Gram</label></td>
               <td><input type="radio" id="gramRadio" name="weightUnit" value="Gram" checked></td>
            </tr>
            <tr>
               <td><label for="grainRadio">Grain</label></td>
               <td><input type="radio" id="grainRadio" name="weightUnit" value="Grain"></td>
            </tr>
         </table>
         <button id="generateButton">Generate Profile</button><br><br>
         <h2>Generated Profile:</h2>
         <textarea id="profileOutput" rows="20" cols="40"></textarea>
         <br>
         <button id="download-btn">Download</button>
         <br><br>
         <button onClick='javascript:history.back()'>Back</button>
      </div>
   </center>
   <script>
      var profileJSON;

      document.getElementById("generateButton").addEventListener("click", function () {
         const measuredWeight = parseFloat(document.getElementById("weightInput").value);
         const speed = parseFloat(document.getElementById("speedInput").value);
         const oscillate = document.getElementById("oscillateCheckbox").checked; // Get the checkbox value
         const weightUnit = document.querySelector('input[name="weightUnit"]:checked').value;

         if (!isNaN(measuredWeight)) {
            const profile = {};

            // Define the conversion factor from grams to grains
            const gramToGrain = 15.4323583529;

            // Define the weight values in grams
            let weights = [1.0, 0.5, 0.25, 0.125, 0.0625, 0.03125, 0.015625, 0.0078125, 0.00390625, 0.000];

            // Convert weights to grains if Grain is selected
            if (weightUnit === "Grain") {
               weights = weights.map(weight => weight * gramToGrain);
            }

            weights = weights.map(weight => parseFloat(weight.toFixed(3)));

            var measurements = 5;

            // Loop through each weight value and calculate the profile
            for (let i = 0; i < weights.length; i++) {
               const weight = weights[i];
               var steps = Math.round((weight / measuredWeight) * 1800);
               if (steps < 5)
                  steps = 5;
               if (i == weights.length - 2)
                  measurements = 15;
               if (i == weights.length - 1)
                  measurements = 20;
               profile[i + 1] = {
                  weight: weight,
                  steps: steps,
                  speed: speed,
                  measurements: measurements,
                  oscillate: oscillate
               };
            }

            // Convert the profile object to JSON format
            profileJSON = JSON.stringify(profile, null, 3);


            document.getElementById("profileOutput").value = profileJSON;
         }
      });

      document.getElementById("copyButton").addEventListener("click", function () {
         // Get the text field
         var copyText = document.getElementById("profileOutput");

         // Select the text field
         copyText.select();
         copyText.setSelectionRange(0, 99999); // For mobile devices

         // Copy the text inside the text field
         navigator.clipboard.writeText(copyText.value);
      });

      document.getElementById("download-btn").addEventListener("click", function () {
         // Get the content from the textarea
         var text = document.getElementById('profileOutput').value;

         // Convert the content to a Blob
         var blob = new Blob([text], { type: 'text/plain' });

         // Create a download link
         var downloadLink = document.createElement('a');
         downloadLink.href = window.URL.createObjectURL(blob);
         downloadLink.download = 'MyPowderName.txt';

         // Append the link to the body, click it, and then remove it
         document.body.appendChild(downloadLink);
         downloadLink.click();
         document.body.removeChild(downloadLink);
      }, false);


   </script>
</body>

</html>